#!/bin/bash

# <bitbar.title>Rsync Checker</bitbar.title>
# <bitbar.version>v1.0</bitbar.version>
# <bitbar.author>Michael Henning</bitbar.author>
# <bitbar.author.github>myklhenn</bitbar.author.github>
# <bitbar.desc>A BitBar plugin that indicates if an instance of rsync is running.</bitbar.desc>
# <bitbar.image>https://raw.githubusercontent.com/myklhenn/rsync-checker-bitbar/master/img/rsync-not-running-and-running.png</bitbar.image>
# <bitbar.abouturl>https://github.com/myklhenn/rsync-checker-bitbar</bitbar.abouturl>

PROC_NAME="rsync"
WARN_TIME="30" # minutes
TERM_CMD="$HOME/.local/bin/iterm" # alternate terminal (such as iTerm) launcher
SERVER_CMD="$(dirname $(readlink $0))/server-command.sh"

CHECK_CIRCLE_ICON="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"
ARROW_CIRCLE_UP_ICON="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"
EXCLAMATION_TRIANGLE_ICON="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"

[ -e $HOME/.rsync-checker-config ] && source $HOME/.rsync-checker-config

if pgrep -aq "^$PROC_NAME$"; then
  PROC_INFO=($(ps axco command,pcpu,etime | grep -e "^$PROC_NAME "))
  if [ ${PROC_INFO[2]:(-5):2} -gt $WARN_TIME ] && [ "${PROC_INFO[1]}" = "0.0" ]; then
    echo "| templateImage=$EXCLAMATION_TRIANGLE_ICON"
    echo "---"
    echo "$PROC_NAME has been running for at least"
    echo "$WARN_TIME minutes... it might be stuck?"
  else
    echo "| templateImage=$ARROW_CIRCLE_UP_ICON"
    echo "---"
    echo "$PROC_NAME is currently running"
  fi
  echo "Stop Process | bash=pkill param1=\"-3\" param2=\"-a\" param3=\"^${PROC_NAME}$\" terminal=false"
else
  echo "| templateImage=$CHECK_CIRCLE_ICON"
  echo "---"
  echo "$PROC_NAME is not running"
  if [ -n "$BACKUP_SCRIPT_PATH" ] && [ -e $SERVER_CMD ]; then
    echo -n "Start Backup Now | "
    if [ -e $TERM_CMD ]; then
      echo "bash=$TERM_CMD param1=\"$SERVER_CMD --start-backup\" terminal=false"
    else
      echo "bash=$SERVER_CMD param1=\"--start-backup\" terminal=true"
    fi
  fi
fi
if [ -n "$BACKUP_LOG_FILE_PATH" ] && [ -e $SERVER_CMD ]; then
  echo -n "Check Backup Log | "
  if [ -e $TERM_CMD ]; then
    echo "bash=$TERM_CMD param1=\"$SERVER_CMD --view-log\" terminal=false"
  else
    echo "bash=$SERVER_CMD param2=\"--view-log\" terminal=true"
  fi
fi
